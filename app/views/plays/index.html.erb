<% title( 'Alle', @pool.full_title ) %>

<% content_for :breadcrumb do %>
 <%= link_to 'Wettpools', pools_path() %> ›
 <%= link_to @pool.full_title, pool_path(@pool) %> ›
 <%= link_to 'Alle Tipps', plays_path( :pool_id => @pool.id ) %>
<% end %>


<p>
  View: <%= link_to 'Tipps', plays_path( :pool_id => @pool.id )  %>
          ⋅
        <%= link_to 'Punkte', plays_path( :pool_id => @pool.id, :pts => 't', :tips => 'f' ) %>
          ⋅
        <%= link_to 'Tipps+Punkte', plays_path( :pool_id => @pool.id, :pts => 't' ) %>
        
</p>

<!-- todo:
   use current_play = nil or obj  instead of machmit  => lets us use play route for edit!!
  -->

<% machmit = (@pool.players.include?( current_user ) == false) %>

<table width='100%' cellspacing=0>
  <tr>
    <!-- left -->
    <td>
      <h1><%= @pool.full_title %> Tipps</h1>
    </td>
    <!-- right -->
    <td style='text-align: right;'>
<% if machmit %>
  <%= link_to 'Mach mit! Mittippen!', add_player_to_pool_path( @pool ), :class => 'btn-primary' %>
<% else %>
  <%= link_to 'Meine Tipps bearbeiten', edit_pool_player_path( @pool, current_user() ), :class => 'btn-primary' %>
<% end %>
    </td>
  </tr>
</table>


<table>
  <tr>
    <td><!-- user --></td>
    <td style='text-align: center;'>1. Platz</td>
    <td style='text-align: center;'>2. Platz</td>
    <% if @pool.team3? %><td style='text-align: center;'>3. Platz</td><% end %>
  </tr>
  <% @users.each do |user| %>
    <% play = Play.find_by_pool_id_and_user_id!( @pool.id, user.id ) %>
    <tr>
       <td>
         <span class='<%= hl_style_for_user(user) %>'>
           <%= link_to user.name, play_path(play.id) %>
         </span>
       </td>
          <!-- fix: use helper or partial -->
       <% if play.team1.present? %>
        <td>
          <% if play.public? %>
            <%= image_tag( play.team1.img ) if play.team1.img.present? %>
            <%= play.team1.title %>
          <% else %>
            Team Anonym
          <% end %>
        </td>
        <% else %>
         <td style='text-align: center;'><span class='missing'>?</span></td>
      <% end %>

       <% if play.team2.present? %>
         <td>
          <% if play.public? %>
            <%= image_tag( play.team2.img ) if play.team2.img.present? %>
            <%= play.team2.title %>
          <% else %>
            Team Anonym
          <% end %>
         </td>
        <% else %>
         <td style='text-align: center;'><span class='missing'>?</span></td>
      <% end %>

    
      <% if @pool.team3? %>
       <% if play.team3.present? %>
        <td>
          <% if play.public? %>
             <%= image_tag( play.team3.img ) if play.team3.img.present? %>
             <%= play.team3.title %>
          <% else %>
            Team Anonym
          <% end %>
        </td>
        <% else %>
         <td style='text-align: center;'><span class='missing'>?</span></td>
        <% end %>
      <% end %>
    </tr>
  <% end %><!-- users.each -->
</table>



<!-- table columns:
        1    => toto12x
        2    => team1
        3..n => tip 
       -3    => result
       -2    => team2
  last/-1    => date
  -->

<table class='plays' cellspacing=0>
<tr>
  <td colspan='2'></td>
  <% @users.each do |user| %>
   <td class='player-name'>
      <span class='<%= hl_style_for_user(user) %>'>
    <%= link_to pool_player_path( @pool, user ) do %>
       <%= raw( user.name.split(' ').join( '<br>' ) ) %>
    <% end %>
      </span>
   </td>
  <% end %><!-- users.each -->
</tr>


<% @rounds.each do |round| %>
<tr class='game-round'>
  <td colspan='2'></td>
  <td colspan='<%= 3+@users.count %>' class='game-round-title'><%= round.title %></td>
</tr>

  <% if @pool.flex? && round.calc? %>
     <tr>
       <td></td>
       <td colspan='<%= 3+@users.count %>' class='game-no-fixtures'>
          Spielaufstellungen noch nicht bekannt.
       </td>
     </tr>
  <% else %>
  <% round.games.each do |game| %>
    <tr>  
       <td class='game-toto12x'>
        <% if game.toto12x.present? %>
          <span class='toto12x'>
            <%= game.toto12x %>
          </span>
        <% end %>
       </td>

       <%= render_game_team1( game ) %>
       
      <% @users.each do |user| %>
        <% tip = Tip.find_by_user_and_pool_and_game( user, @pool, game ) %>
        

<% if tip.present? %>
  <td class='tip-score'>

    <% if @show_tips %>
      <span class='<%= tip.bingo_style_class %>'>
        <%= tip.public_score_str %>
      </span>
    <% end %>
    
    <% if @show_pts %>
       <% if tip.calc_points > 0 %>
         <span class='<%= tip.bingo_style_class %>'>
          <%= tip.calc_points_str %> <%= tip.calc_points %> 
         </span>
       <% elsif game.toto12x.present? %>
          ×
       <% else %>
         <!-- no game results (toto12x) yet available -->
       <% end %>
    <% end %>
  </td>
<% else %>
  <td class='tip-score'>
    ♦<!-- fehler: datensatz fehlt! -->
  </td>
<% end %>

      <% end %><!-- users.each --> 

       <%= render_game_score( game ) %>
       <%= render_game_team2( game ) %>
       <%= render_game_date( game ) %>
     </tr>
  <% end %> <!-- games.each -->
 <% end %> <!-- if pool.flex? && round.calc? -->  
<% end %> <!-- rounds.each -->

<tr>
  <td colspan='2'></td>
  <% @users.each do |user| %>
   <td class='player-name'>
      <span class='<%= hl_style_for_user(user) %>'>
    <%= link_to pool_player_path( @pool, user ) do %>
       <%= raw( user.name.split(' ').join( '<br>' ) ) %>
    <% end %>
      </span>
   </td>
  <% end %><!-- users.each -->
</tr>

</table>