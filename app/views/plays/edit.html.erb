<% title( @user.name, @pool.full_title ) %>

<% content_for :breadcrumb do %>
 <%= link_to 'Wettpools', pools_path() %> ›
 <%= link_to @pool.full_title, pool_path(@pool) %> ›
 <%= link_to @user.name, edit_play_path( @play ) %>
<% end %>

<p class='view'>
  View: <%= link_to 'Tipps', edit_play_path( @play, :odds => 'f' ) %>
          ⋅
        <%= link_to 'Tipps+Quoten', edit_play_path( @play, :odds => 't' ) %>
</p>


<!-- add hotkey handler for quick tip autofill -->
<script>

 // function testTimer()
 // {
 //   $( '#debug').append( '<p>' + new Date().toString() + '</p>' );
 // }

 $(document).ready( function() {  
  
  recalcPlayTips();
  
  $(document).on( 'keydown', function( event ) {
    if( (event.ctrlKey && event.which == 81) || (event.which == 81) )  // ASCII 81 = Q (Quicktipp)
    {
       event.preventDefault();
       autofillPlayTips();
       recalcPlayTips();
       return false;  // todo: check if return false is  needed?
     }
     else if( (event.ctrlKey && event.which == 67) || (event.which == 67) )  // ASCII 67 = C (Clean/Clear)
     {
       event.preventDefault();
       clearPlayTips();
       recalcPlayTips();
       return false;  // todo: check if return false is  needed?      
     }
     else if( (event.ctrlKey && event.which == 82) || (event.which == 82) )  // ASCII 82 = R (Refresh/Recalcuate)
     {
       event.preventDefault();
       recalcPlayTips();
       return false;  // todo: check if return false is  needed?
     }
  });
  
  // quick and dirty hack
  //  do a recalc every ~2 seconds (e.g. 1500 ms)
  
  var recalcTimer = setInterval( recalcPlayTips, 1500 );
  
});
</script>


<table width='100%' cellspacing=0>
  <tr>
    <!-- left -->
    <td>
       <h1><%= @user.name %> - <%=  @pool.full_title %> Tipps</h1>
    </td>
    <!-- right -->
    <td style='text-align: right;'>
        <%= link_to 'Quicktipp', '#', :class => 'btn', :onclick => 'autofillPlayTips();' %>
    </td>
  </tr>
</table>





<%= form_for @play, :url => play_path( @play ), :html => { :method => 'put' } do |f| %>  

<% if @pool.locked? %>
  <% if @pool.flex? %>
    <p class='flash notice'><b>Hinweis.</b> Team Abgabefrist abgelaufen. Team Bonustipps gesperrt.</p>
  <% else %>
    <p class='flash notice'><b>Hinweis.</b> Abgabefrist abgelaufen. Tippabgabe gesperrt.</p>
  <% end %>
  
  <%= f.hidden_field :team1_id %>
  <%= f.hidden_field :team2_id %>
<table>
 <tr>
   <td>1. Platz</td>
       <!-- fix: use helper or partial -->
     <% if @play.team1.present? %>
         <td>
            <%= image_tag( @play.team1.img ) if @play.team1.img.present? %>
            <%= @play.team1.title %>
         </td>
       <% else %>
         <td style='text-align: center;'>
           <span class='missing'>?</span>
         </td>
       <% end %>
 </tr>
 <tr>
   <td>2. Platz</td>
       <% if @play.team2.present? %>
        <td>
            <%= image_tag( @play.team2.img ) if @play.team2.img.present? %>
            <%= @play.team2.title %>
        </td>
       <% else %>
         <td style='text-align: center;'>
           <span class='missing'>?</span>
          </td>
       <% end %>
 </tr>
</table>
<% else %><!-- pool.locked? clause -->
<% if @pool.flex? %>
 <!-- NB: only needed for flex - in fixed winner gets calculated automatically -->
<table>
 <tr>
   <td><%= f.label :team1_id, '1. Platz' %></td>
   <td><%= f.select :team1_id, Lookup.team_options_for_event( @pool.event ) %></td>
 </tr>
 <tr>
   <td><%= f.label :team2_id, '2. Platz' %></td>
   <td><%= f.select :team2_id, Lookup.team_options_for_event( @pool.event ) %></td>
 </tr>
 <% if @pool.team3? %>
 <tr>
   <td><%= f.label :team3_id, '3. Platz' %></td>
   <td><%= f.select :team3_id, Lookup.team_options_for_event( @pool.event ) %></td>
 </tr>
  <% end %><!-- if pool.team3? -->
</table>

<% else %><!-- pool fix clause -->
  <%= f.hidden_field :team1_id %>
  <%= f.hidden_field :team2_id %>
<% end %><!-- pool.flex? -->
<% end %><!-- pool.locked? -->



<% if @show_odds %>
<table class='odds'>
 <tr>
<% Service.all.each do |srv| %>
   <td>
    <%= srv.title %><br>
  <% srv.event_quotes.where( :event_id => @pool.event.id ).each do |quote| %>
     <%= quote.team.tag %> <%= fmt_quote( quote.odds ) %><br>
  <% end %><!-- each qoute -->
  </td>
<% end %><!-- each service -->
</tr>
</table>
<% end %><!-- show odds? -->




<% if @pool.flex? %>
  <%= render :partial => 'games_by_round',  :locals => { :rounds => @pool.event.flex_rounds, :user => @user, :pool => @pool, :f => f, :tabindex => 1000, :show_odds => @show_odds } %>
  <!-- todo: include group tables if groups exist -->
<% else %>
  <%= render :partial => 'games_by_group',  :locals => { :groups => @pool.event.groups, :user => @user, :pool => @pool, :f => f, :tabindex => 1000, :show_odds => @show_odds } %>
  <%= render :partial => 'games_by_round',  :locals => { :rounds => @pool.event.fix_playoff_rounds, :user => @user, :pool => @pool, :f => f, :tabindex => 2000, :show_odds => @show_odds } %>
<% end %>



<p>
  <%= f.submit "Tipps speichern", :class => 'btn-primary' %>
  <%= link_to 'Zurück', play_path( @play ), :class => 'btn' %>
</p>  
<% end %>

<div id='debug' style='display: none;'></div>